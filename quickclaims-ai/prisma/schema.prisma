// QuickClaims AI - Prisma Schema
// Based on data models from docs/planning/08-data-models.md

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// ENUMS
// ============================================================================

enum UserRole {
  admin
  manager
  estimator
  contractor
}

enum ClaimStatus {
  new_supplement
  missing_info
  contractor_review
  supplement_in_progress
  supplement_sent
  awaiting_carrier_response
  reinspection_requested
  reinspection_scheduled
  approved
  final_invoice_pending
  final_invoice_sent
  completed
  closed_lost
}

enum JobType {
  supplement
  reinspection
  estimate
  final_invoice
}

enum LossType {
  hail
  wind
  fire
  other
}

enum SupplementStatus {
  draft
  submitted
  pending
  approved
  denied
  partial
}

enum AdjusterType {
  desk
  field
  independent
}

enum NoteType {
  general
  status_change
  call
  email
  document
}

enum DocumentType {
  insurance_scope
  signed_agreement
  measurement_report
  photo_inspection
  supplement_estimate
  material_invoice
  final_invoice
  carrier_correspondence
  other
}

// ============================================================================
// MODELS
// ============================================================================

model User {
  id                 String     @id @default(cuid())
  clerkId            String     @unique
  email              String     @unique
  firstName          String
  lastName           String
  role               UserRole   @default(estimator)
  isActive           Boolean    @default(true)
  createdAt          DateTime   @default(now())
  updatedAt          DateTime   @updatedAt
  lastLoginAt        DateTime?

  // Relations
  estimatorProfile   Estimator?
  contractor         Contractor? @relation(fields: [contractorId], references: [id])
  contractorId       String?
  notes              Note[]
  supplements        Supplement[] @relation("CreatedBy")
  documents          Document[]
  preferences        UserPreferences?

  @@index([role])
  @@index([clerkId])
  @@map("users")
}

model Contractor {
  id                String   @id @default(cuid())
  companyName       String
  contactName       String?
  email             String
  phone             String?
  address           String?
  
  // Rate fields by job type
  billingPercentage   Decimal  @db.Decimal(5, 4) // Legacy/default: 0.1000 to 0.2000 (10-20%)
  residentialRate     Decimal? @db.Decimal(5, 4) // Residential supplement rate
  commercialRate      Decimal? @db.Decimal(5, 4) // Commercial supplement rate
  reinspectionRate    Decimal? @db.Decimal(5, 4) // Reinspection rate
  estimateFlatFee     Decimal? @db.Decimal(10, 2) // Flat fee for estimates (dollar amount)
  
  paymentTerms      String?
  notes             String?  @db.Text
  isActive          Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  claims            Claim[]
  users             User[]

  @@index([companyName])
  @@index([isActive])
  @@map("contractors")
}

model Estimator {
  id                   String   @id @default(cuid())
  userId               String?  @unique
  firstName            String
  lastName             String
  email                String
  phone                String?
  
  // Commission rate fields by job type
  commissionPercentage Decimal  @db.Decimal(5, 4) // Legacy/default: 0.0500 (5%)
  residentialRate      Decimal? @db.Decimal(5, 4) // Residential supplement commission rate
  commercialRate       Decimal? @db.Decimal(5, 4) // Commercial supplement commission rate
  reinspectionRate     Decimal? @db.Decimal(5, 4) // Reinspection commission rate
  estimateFlatFee      Decimal? @db.Decimal(10, 2) // Flat fee for estimates (dollar amount)
  
  hireDate             DateTime?
  isActive             Boolean  @default(true)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  // Relations
  user                 User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  claims               Claim[]

  @@index([isActive])
  @@index([lastName])
  @@map("estimators")
}

model Carrier {
  id        String   @id @default(cuid())
  name      String   @unique
  phone     String?
  email     String?
  website   String?
  notes     String?  @db.Text
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  claims    Claim[]
  adjusters Adjuster[]

  @@index([isActive])
  @@map("carriers")
}

model Adjuster {
  id        String        @id @default(cuid())
  carrierId String
  name      String
  email     String?
  phone     String?
  type      AdjusterType  @default(desk)
  isActive  Boolean       @default(true)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  // Relations
  carrier   Carrier       @relation(fields: [carrierId], references: [id])
  claims    Claim[]

  @@index([carrierId])
  @@index([name])
  @@index([isActive])
  @@map("adjusters")
}

model Claim {
  id                String      @id @default(cuid())

  // Policyholder Info
  policyholderName  String
  policyholderEmail String?
  policyholderPhone String?
  policyholderWorkPhone String?
  policyholderFax   String?
  lossAddress       String
  lossAddressLine2  String?
  lossCity          String
  lossState         String      @db.Char(2)
  lossZip           String

  // Claim Info
  claimNumber       String?
  policyNumber      String?
  dateOfLoss        DateTime?
  lossType          LossType?

  // Relationships
  contractorId      String
  estimatorId       String
  carrierId         String
  adjusterId        String?

  // Direct Adjuster Info (for when adjuster not in system or override)
  adjusterNameOverride  String?
  adjusterPhoneOverride String?
  adjusterEmailOverride String?

  // Supervisor Info
  supervisorName    String?
  supervisorPhone   String?

  // External References
  contractorCrmId   String?     // Contractor's CRM reference
  externalJobNumber String?     // External job number

  // Job Classification
  jobType           JobType     @default(supplement)
  status            ClaimStatus @default(new_supplement)

  // Financial - Initial (from insurance scope)
  totalSquares      Decimal     @db.Decimal(10, 2)
  roofRCV           Decimal     @db.Decimal(12, 2)      // Initial Roof RCV
  initialRCV        Decimal     @db.Decimal(12, 2)      // Initial Total RCV
  dollarPerSquare   Decimal     @default(0) @db.Decimal(10, 2) // Initial $/SQ (calculated)

  // Financial - Final (updated as claim progresses)
  finalRoofRCV      Decimal?    @db.Decimal(12, 2)      // Final Roof RCV after all supplements
  finalTotalRCV     Decimal?    @db.Decimal(12, 2)      // Final Total RCV
  finalDollarPerSquare Decimal? @db.Decimal(10, 2)      // Final $/SQ

  // Financial - Computed/Tracking
  currentTotalRCV          Decimal  @default(0) @db.Decimal(12, 2)
  totalIncrease            Decimal  @default(0) @db.Decimal(12, 2)
  percentageIncrease       Decimal  @default(0) @db.Decimal(8, 4)
  contractorBillingAmount  Decimal  @default(0) @db.Decimal(12, 2)
  estimatorCommission      Decimal  @default(0) @db.Decimal(12, 2)

  // Money Released
  moneyReleasedAmount Decimal?  @db.Decimal(12, 2)

  // Billing Payment Tracking
  billingPaidAt       DateTime?           // When marked as paid
  billingPaidById     String?             // User who marked it paid

  // Timestamps
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  lastActivityAt    DateTime    @default(now())
  statusChangedAt   DateTime    @default(now())
  completedAt       DateTime?

  // Relations
  contractor        Contractor  @relation(fields: [contractorId], references: [id])
  estimator         Estimator   @relation(fields: [estimatorId], references: [id])
  carrier           Carrier     @relation(fields: [carrierId], references: [id])
  adjuster          Adjuster?   @relation(fields: [adjusterId], references: [id])
  supplements       Supplement[]
  notes             Note[]
  documents         Document[]

  @@index([contractorId])
  @@index([estimatorId])
  @@index([carrierId])
  @@index([status])
  @@index([lastActivityAt])
  @@index([policyholderName])
  @@index([claimNumber])
  @@index([billingPaidAt])
  @@map("claims")
}

model Supplement {
  id             String           @id @default(cuid())
  claimId        String
  sequenceNumber Int              @default(1) // SOL 1, SOL 2, etc.

  // Financial - Total RCV
  amount         Decimal          @db.Decimal(12, 2)  // Increase amount
  previousRCV    Decimal          @db.Decimal(12, 2)  // Previous Total RCV
  newRCV         Decimal          @db.Decimal(12, 2)  // New Total RCV

  // Financial - Roof Specific
  previousRoofRCV Decimal?        @db.Decimal(12, 2)  // Previous Roof RCV
  newRoofRCV      Decimal?        @db.Decimal(12, 2)  // New Roof RCV
  roofIncrease    Decimal?        @db.Decimal(12, 2)  // Roof-specific increase

  // Details (description contains line items info)
  description    String           @db.Text
  lineItems      Json?
  omApproved     Boolean          @default(false) // Was O&M (Overhead & Margin) approved

  // Status
  status         SupplementStatus @default(draft)
  submittedAt    DateTime?
  approvedAt     DateTime?
  approvedAmount Decimal?         @db.Decimal(12, 2)

  // Metadata
  createdById    String
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  // Relations
  claim          Claim            @relation(fields: [claimId], references: [id], onDelete: Cascade)
  createdBy      User             @relation("CreatedBy", fields: [createdById], references: [id])

  @@index([claimId])
  @@index([status])
  @@index([claimId, sequenceNumber])
  @@map("supplements")
}

model Note {
  id         String   @id @default(cuid())
  claimId    String
  userId     String
  content    String   @db.Text
  type       NoteType @default(general)
  isInternal Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  claim      Claim    @relation(fields: [claimId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id])

  @@index([claimId, createdAt])
  @@index([type])
  @@map("notes")
}

model Document {
  id               String       @id @default(cuid())
  claimId          String
  filename         String
  originalFilename String
  mimeType         String
  size             Int
  url              String
  type             DocumentType
  description      String?
  uploadedById     String
  uploadedAt       DateTime     @default(now())

  // Relations
  claim            Claim        @relation(fields: [claimId], references: [id], onDelete: Cascade)
  uploadedBy       User         @relation(fields: [uploadedById], references: [id])

  @@index([claimId])
  @@index([type])
  @@map("documents")
}

model AuditLog {
  id          String   @id @default(cuid())
  userId      String
  userEmail   String
  action      String   // create, update, delete, status_change, approve
  entityType  String   // claim, supplement, note, contractor, etc.
  entityId    String
  fieldName   String?  // for updates: which field changed
  oldValue    String?  @db.Text
  newValue    String?  @db.Text
  metadata    Json?    // additional context
  createdAt   DateTime @default(now())

  @@index([entityType, entityId])
  @@index([userId])
  @@index([createdAt])
  @@index([action])
  @@map("audit_logs")
}

// ============================================================================
// SETTINGS MODELS
// ============================================================================

model UserPreferences {
  id                    String   @id @default(cuid())
  userId                String   @unique

  // Notification Preferences
  emailStatusChanges    Boolean  @default(true)
  emailSupplements      Boolean  @default(true)
  email48HourReminders  Boolean  @default(true)
  emailWeeklySummary    Boolean  @default(false)

  // Appearance Preferences
  theme                 String   @default("system") // light, dark, system
  sidebarCollapsed      Boolean  @default(false)
  dateFormat            String   @default("MM/DD/YYYY")
  claimsPerPage         Int      @default(20)

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  // Relations
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_preferences")
}

model OrganizationSettings {
  id                    String   @id @default(cuid())
  clerkOrgId            String   @unique

  // Company Information
  companyName           String?
  logoUrl               String?
  primaryContactEmail   String?
  businessAddress       String?  @db.Text

  // Default Percentages
  defaultBillingPct     Decimal  @default(0.125) @db.Decimal(5, 4)
  defaultCommissionPct  Decimal  @default(0.05) @db.Decimal(5, 4)

  // Compliance Settings
  complianceHours       Int      @default(48)

  // Report Customization
  reportHeader          String?  @db.Text
  reportFooter          String?  @db.Text

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@map("organization_settings")
}
